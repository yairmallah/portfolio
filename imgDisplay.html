<!DOCTYPE html>
<html lang="he">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel="icon" href="./imgs/sys/fav.svg" sizes="any">
		<title></title>
		<link rel="stylesheet" type="text/css" href="css\general.css"/>
		<link rel="stylesheet" type="text/css" href="css\imgDisplay.css"/>
		<script>
			function waitForVideoLoad(timeout = 2000, act) {
				const start = Date.now();
				(function check() {
					try{
						let vid = document.getElementById("myVideo");
						let source = document.getElementById("vidSource");
						if (vid != null && source != null) {
							act();
						} else if (Date.now() - start < timeout) {
							setTimeout(check, 50); // keep checking
						} else {
							console.warn("video not available in after timeout");
						}
					}
					catch (e){
						if (Date.now() - start < timeout) {
							setTimeout(check, 50); // keep checking
						} else {
							console.warn("video not available in after timeout");
						}
					}
				})();
			}
			function loadImg(src){
				function getType(src){
					if (src.endsWith(".mp4")) return "vid";
					if ((src.endsWith(".jpg"))||(src.endsWith(".png"))||(src.endsWith(".mp4"))||(src.endsWith(".gif"))||(src.endsWith(".svg"))||(src.endsWith(".jpeg"))||(src.endsWith(".webp"))) return "img";
				}
				window.imgSrc = src;
				let add_name = src.split("/");
				add_name = add_name[add_name.length - 1];
				add_name = add_name.split(".");
				add_name = add_name[0];
				
				document.querySelector("title").textContext = add_name;
				document.getElementById("img-container").innerHTML = "";
				let actImg;
				if (getType(src) == "img"){
					actImg = document.createElement("img");
					actImg.src = window.imgSrc;
				}
				else if (getType(src) == "vid"){
					console.log(window.imgSrc);
					actImg = document.createElement("video");
					actImg.src = window.imgSrc;
					actImg.controls = true;
					actImg.muted = true;
					try {
						waitForVideoLoad(actImg.play());
					}
					catch (error) {
						console.warn(error);
					}
				}
				actImg.id = "img";
				console.log(actImg);
				document.getElementById("img-container").appendChild(actImg);
			}
		</script>
		<script>
			function loadTxt(src){
				fetch(src)
					.then(response => response.text())
					.then(html => {
						let parser = new DOMParser();
						let doc = parser.parseFromString(html, "text/html");
						let targetElement = doc.querySelector("body");
						if (targetElement) {
						document.getElementById("text-container").innerHTML = targetElement.innerHTML;
						}
					});
			}
		</script>
		
	</head>
	<body>
		<div id="content-container">
			<div id="text-container"></div>
			<div id="img-container"></div>
		</div>
		<script>
			
			const params = new URLSearchParams(window.location.search);
			const imgAdd = params.get('img');
			if (imgAdd[0] === '$'){
				window.currentImgIndex = 0;
				const imgAdds = imgAdd.split('$').slice(1)
				
				
				function packRoatation(){					
					if (!window.rotationPackedFlag) document.querySelector("#img-container #img").addEventListener('click', (e) => {
						window.rotationPackedFlag = true;
						const screenMiddle = window.innerWidth / 2;
						const clickX = event.clientX;
						if (clickX < screenMiddle) window.currentImgIndex += imgAdds.length - 1;
						else window.currentImgIndex += 1;
						window.currentImgIndex = window.currentImgIndex % imgAdds.length;
						loadImg(imgAdds[window.currentImgIndex]);
						window.rotationPackedFlag = false;
						packRoatation();
						window.rotationPackedFlag = true;
					});
				}
				loadImg(imgAdds[0]);
				packRoatation();
			}
			else loadImg(imgAdd);
			const txtAdd = params.get('txt');
			
			if (txtAdd) loadTxt(txtAdd);
			else {
				document.getElementById("text-container").classList.toggle("hidden", true);
				document.getElementById("img-container").style.margin = "auto";
				document.querySelector("#img-container #img").style.maxWidth = "100%";
			}
		</script>
	</body>
</html>
